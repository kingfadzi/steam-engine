# AlmaLinux 9 test container for steampipe bundle
#
# This simulates the target air-gapped WSL environment.
# The bundle is copied in and extracted, then steampipe is started.
#
FROM almalinux:9

# Install minimal dependencies (what would exist on target)
RUN dnf install -y \
    postgresql \
    procps-ng \
    && dnf clean all

# Create steampipe user (non-root)
RUN useradd -m -s /bin/bash steampipe

# Create directories
RUN mkdir -p /opt/steampipe /etc/steampipe \
    && chown -R steampipe:steampipe /opt/steampipe /etc/steampipe

# Copy and extract bundle (done at build time for testing)
COPY --chown=steampipe:steampipe bundle/ /opt/steampipe/

# Create config directory and copy test configs (steampipe reads from $INSTALL_DIR/config)
RUN mkdir -p /opt/steampipe/config && chown steampipe:steampipe /opt/steampipe/config
COPY --chown=steampipe:steampipe test-config/*.spc /opt/steampipe/config/

# Set up environment
COPY --chown=steampipe:steampipe steampipe.env /opt/steampipe/steampipe.env

# Switch to steampipe user
USER steampipe
WORKDIR /opt/steampipe

# Expose steampipe port
EXPOSE 9193

# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD pg_isready -h localhost -p 9193 -U steampipe || exit 1

# Default command: run server
CMD ["./bin/server"]
